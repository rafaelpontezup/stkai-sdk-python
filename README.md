# stkai

Python SDK for StackSpot AI - Remote Quick Commands and more.

## Installation

```bash
pip install stkai
```

For development:

```bash
pip install stkai[dev]
```

## Requirements

- Python 3.12+
- StackSpot CLI (`oscli`) installed and authenticated

## Quick Start

```python
from stkai import RemoteQuickCommand, RqcRequest

# Create a client for your Quick Command
rqc = RemoteQuickCommand(slug_name="my-quick-command")

# Execute a request
response = rqc.execute(
    request=RqcRequest(payload={"code": "def hello(): pass"})
)

if response.is_completed():
    print(f"Result: {response.result}")
else:
    print(f"Error: {response.error}")
```

## Usage Guide

The `RemoteQuickCommand` (RQC) is a client abstraction that simplifies sending requests and handling responses from StackSpot AI.

### 1. Sending a Single Request

```python
from pathlib import Path
from stkai import RemoteQuickCommand, RqcRequest, RqcResponse

# Prepare the payload
file_path = Path("product_service.py")
code = {
    "file_name": file_path.name,
    "source_code": file_path.read_text(encoding="utf-8")
}

# Send a request
rqc = RemoteQuickCommand(slug_name="explain-code-to-me")
response: RqcResponse = rqc.execute(
    request=RqcRequest(payload=code, id=file_path.name),
)

print(f"Response result: {response.result}")
```

The `execute` method **always** returns an `RqcResponse` instance, regardless of success or failure. If the request's `id` is not provided, a UUIDv4 is generated by default.

### 2. Using Custom Result Handlers

By default, responses are processed using `JsonResultHandler` to deserialize JSON results into Python objects. You can provide a custom handler:

```python
from stkai.rqc import RqcResultHandler, RqcResultContext

class MyXMLResultHandler(RqcResultHandler):
    def handle_result(self, context: RqcResultContext):
        raw_result = context.raw_result
        return XmlParser.parse(raw_result)

# Use your custom handler
result_handler = MyXMLResultHandler()
response = rqc.execute(
    request=RqcRequest(payload=code),
    result_handler=result_handler
)
```

#### Chaining Multiple Handlers

Chain multiple handlers for logging, validation, or transformation:

```python
from stkai.rqc import ChainedResultHandler, JsonResultHandler

custom_handler = ChainedResultHandler.of([
    LogRawResultHandler(),
    JsonResultHandler(),
    SaveResultHandler(output_dir="/tmp/output"),
])

response = rqc.execute(
    request=RqcRequest(payload=code),
    result_handler=custom_handler
)
```

Or use `chain_with` for simple JSON + custom handler chains:

```python
from stkai.rqc import JsonResultHandler

handler = JsonResultHandler.chain_with(MyDomainModelHandler())
```

### 3. Executing Multiple Requests Concurrently

Send multiple requests in parallel using `execute_many`:

```python
source_files = [
    {"file_name": "order.py", "source_code": "..."},
    {"file_name": "controller.py", "source_code": "..."},
]

rqc = RemoteQuickCommand(slug_name="refactor-code")
responses = rqc.execute_many(
    request_list=[
        RqcRequest(payload=f, id=f["file_name"]) for f in source_files
    ]
)

for seq, resp in enumerate(responses, start=1):
    print(f"{seq} | Result: {resp.result}")
```

### 4. Filtering Responses

Filter responses by status:

```python
responses = rqc.execute_many(request_list=requests)

# Get only successful responses
completed = [r for r in responses if r.is_completed()]

# Check for failures
failed = [r for r in responses if r.is_failure()]
errors = [r for r in responses if r.is_error()]
timeouts = [r for r in responses if r.is_timeout()]
```

## Configuration

`RemoteQuickCommand` accepts several configuration options:

```python
from pathlib import Path
from stkai import RemoteQuickCommand

rqc = RemoteQuickCommand(
    slug_name="my-quick-command",
    poll_interval=10.0,        # Seconds between status checks (default: 10)
    poll_max_duration=600.0,   # Max wait time in seconds (default: 600 = 10min)
    max_workers=8,             # Concurrent requests for execute_many (default: 8)
    max_retries=3,             # Retries for failed requests (default: 3)
    backoff_factor=0.5,        # Exponential backoff factor (default: 0.5)
    output_dir=Path("output"), # Directory for request/response logs
)
```

## Response Status

| Status | Description |
|--------|-------------|
| `COMPLETED` | Request executed successfully |
| `FAILURE` | Server-side execution failure |
| `ERROR` | Client-side error (network, parsing, etc.) |
| `TIMEOUT` | Polling exceeded max duration |

## Development

```bash
# Clone the repository
git clone https://github.com/rafaelpontezup/stkai-sdk.git
cd stkai-sdk

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install in development mode
pip install -e ".[dev]"

# Run tests
pytest

# Run linter
ruff check src tests

# Run type checker
mypy src
```

## License

Apache License 2.0 - see [LICENSE](LICENSE) for details.
